<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Puffy Sprite Debug - Image Analysis</title>
    
    <style>
        body {
            background: linear-gradient(135deg, #2D1B69 0%, #1a0f3a 100%);
            color: #fff;
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
        }
        
        .debug-section {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .debug-section h3 {
            color: #00ffff;
            margin-top: 0;
        }
        
        #raw-image, #scaled-image {
            border: 2px solid #00ffff;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><rect width="10" height="10" fill="%23ccc"/><rect x="10" y="10" width="10" height="10" fill="%23ccc"/><rect x="10" width="10" height="10" fill="%23fff"/><rect y="10" width="10" height="10" fill="%23fff"/></svg>');
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            border: 2px solid #00ffff;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            margin: 10px 0;
        }
        
        .frame-preview {
            border: 1px solid #00ffff;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><rect width="10" height="10" fill="%23444"/><rect x="10" y="10" width="10" height="10" fill="%23444"/><rect x="10" width="10" height="10" fill="%23666"/><rect y="10" width="10" height="10" fill="%23666"/></svg>');
            image-rendering: pixelated;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            text-align: center;
            min-height: 64px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            font-family: monospace;
        }
        
        .info-label {
            color: #00ffff;
            font-weight: bold;
        }
        
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ff6b6b;
        }
        
        .success {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #4CAF50;
        }
        
        button {
            background: rgba(0, 255, 255, 0.3);
            border: 2px solid #00ffff;
            border-radius: 8px;
            color: #fff;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: rgba(0, 255, 255, 0.6);
        }
    </style>
</head>
<body>
    <h1 style="color: #00ffff; text-align: center;">üê± Puffy Sprite Debug Analysis</h1>
    
    <div class="debug-section">
        <h3>üìÅ Raw Sprite Sheet Analysis</h3>
        <div id="loading-status">Loading puffy_4_by_4.png...</div>
        
        <div id="image-analysis" style="display: none;">
            <div class="info-grid">
                <span class="info-label">File Path:</span>
                <span id="file-path">assets/puffy_4_by_4.png</span>
                
                <span class="info-label">Image Dimensions:</span>
                <span id="image-dimensions">Detecting...</span>
                
                <span class="info-label">Calculated Frame Size:</span>
                <span id="frame-size">Calculating...</span>
                
                <span class="info-label">Total Frames Expected:</span>
                <span>16 (4√ó4 grid)</span>
                
                <span class="info-label">Image Format:</span>
                <span id="image-format">PNG with transparency</span>
                
                <span class="info-label">Load Status:</span>
                <span id="load-status">Loading...</span>
            </div>
            
            <h4>Raw Sprite Sheet (Actual Size):</h4>
            <img id="raw-image" alt="Puffy 4x4 Sprite Sheet" style="display: none;">
            
            <h4>Raw Sprite Sheet (Scaled 4x for visibility):</h4>
            <img id="scaled-image" alt="Puffy 4x4 Sprite Sheet Scaled" style="display: none;">
        </div>
        
        <div id="error-display" style="display: none;" class="error">
            <h4>‚ùå Loading Error</h4>
            <div id="error-message"></div>
        </div>
    </div>
    
    <div class="debug-section">
        <h3>üîç Frame Detection & Extraction</h3>
        <div id="frame-analysis">
            <p>Waiting for image analysis...</p>
        </div>
        
        <div id="extracted-frames" style="display: none;">
            <h4>Extracted 4√ó4 Frame Grid:</h4>
            <div class="frame-grid" id="frame-grid">
                <!-- Frames will be populated here -->
            </div>
        </div>
    </div>
    
    <div class="debug-section">
        <h3>üéÆ Phaser.js Integration Test</h3>
        <button id="test-phaser">Test with Phaser.js</button>
        <button id="test-manual-slice">Manual Frame Extraction</button>
        <button id="download-analysis">Download Analysis Report</button>
        
        <div id="phaser-test-result" style="display: none; margin-top: 15px;">
            <div id="phaser-canvas-container"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <script>
        class SpriteDetector {
            constructor() {
                this.image = null;
                this.canvas = null;
                this.ctx = null;
                this.frameWidth = 0;
                this.frameHeight = 0;
                this.imageData = null;
                
                this.init();
            }
            
            async init() {
                console.log('üîç Starting sprite detection analysis...');
                await this.loadAndAnalyzeImage();
            }
            
            async loadAndAnalyzeImage() {
                try {
                    console.log('üì• Loading puffy_4_by_4.png...');
                    
                    // Create image element
                    this.image = new Image();
                    this.image.crossOrigin = 'anonymous'; // For canvas access
                    
                    // Set up load handlers
                    this.image.onload = () => {
                        console.log('‚úÖ Image loaded successfully!');
                        this.analyzeImageDimensions();
                        this.displayRawImage();
                        this.extractFrames();
                    };
                    
                    this.image.onerror = (error) => {
                        console.error('‚ùå Failed to load image:', error);
                        this.showError('Failed to load puffy_4_by_4.png. Check if file exists and server is running.');
                    };
                    
                    // Load the image
                    this.image.src = 'assets/puffy_4_by_4.png?t=' + Date.now(); // Cache busting
                    
                } catch (error) {
                    console.error('‚ùå Error in loadAndAnalyzeImage:', error);
                    this.showError(error.message);
                }
            }
            
            analyzeImageDimensions() {
                const width = this.image.naturalWidth;
                const height = this.image.naturalHeight;
                
                console.log(`üìê Image dimensions: ${width}x${height}`);
                
                // Calculate frame size (4x4 grid)
                this.frameWidth = Math.floor(width / 4);
                this.frameHeight = Math.floor(height / 4);
                
                console.log(`üìê Calculated frame size: ${this.frameWidth}x${this.frameHeight}`);
                
                // Update UI
                document.getElementById('image-dimensions').textContent = `${width}x${height} pixels`;
                document.getElementById('frame-size').textContent = `${this.frameWidth}x${this.frameHeight} pixels`;
                document.getElementById('load-status').textContent = '‚úÖ Loaded successfully';
                document.getElementById('load-status').style.color = '#4CAF50';
                
                // Show analysis section
                document.getElementById('loading-status').style.display = 'none';
                document.getElementById('image-analysis').style.display = 'block';
                
                // Update frame analysis
                document.getElementById('frame-analysis').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Image Analysis Complete</h4>
                        <p><strong>Total Size:</strong> ${width}√ó${height} pixels</p>
                        <p><strong>Frame Size:</strong> ${this.frameWidth}√ó${this.frameHeight} pixels</p>
                        <p><strong>Grid Layout:</strong> 4√ó4 = 16 frames</p>
                        <p><strong>File Format:</strong> PNG with transparency support</p>
                    </div>
                `;
            }
            
            displayRawImage() {
                const rawImg = document.getElementById('raw-image');
                const scaledImg = document.getElementById('scaled-image');
                
                // Show actual size
                rawImg.src = this.image.src;
                rawImg.style.width = this.image.naturalWidth + 'px';
                rawImg.style.height = this.image.naturalHeight + 'px';
                rawImg.style.display = 'block';
                
                // Show scaled version (4x larger for visibility)
                scaledImg.src = this.image.src;
                scaledImg.style.width = (this.image.naturalWidth * 4) + 'px';
                scaledImg.style.height = (this.image.naturalHeight * 4) + 'px';
                scaledImg.style.display = 'block';
            }
            
            extractFrames() {
                console.log('‚úÇÔ∏è Extracting individual frames...');
                
                // Create canvas for frame extraction
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                
                const frameGrid = document.getElementById('frame-grid');
                frameGrid.innerHTML = ''; // Clear existing frames
                
                // Extract each frame
                for (let row = 0; row < 4; row++) {
                    for (let col = 0; col < 4; col++) {
                        const frameIndex = row * 4 + col;
                        const frameCanvas = this.extractSingleFrame(col, row, frameIndex);
                        
                        // Create frame preview element
                        const framePreview = document.createElement('div');
                        framePreview.className = 'frame-preview';
                        framePreview.innerHTML = `
                            <div>
                                Frame ${frameIndex}<br>
                                Row ${row}, Col ${col}<br>
                                <canvas style="border: 1px solid #00ffff; margin: 5px; image-rendering: pixelated;" 
                                        width="${this.frameWidth * 3}" height="${this.frameHeight * 3}"></canvas>
                            </div>
                        `;
                        
                        // Scale and draw the frame
                        const previewCanvas = framePreview.querySelector('canvas');
                        const previewCtx = previewCanvas.getContext('2d');
                        previewCtx.imageSmoothingEnabled = false;
                        previewCtx.drawImage(frameCanvas, 0, 0, this.frameWidth * 3, this.frameHeight * 3);
                        
                        frameGrid.appendChild(framePreview);
                    }
                }
                
                document.getElementById('extracted-frames').style.display = 'block';
                console.log('‚úÖ Frame extraction complete!');
            }
            
            extractSingleFrame(col, row, frameIndex) {
                // Create canvas for this frame
                const frameCanvas = document.createElement('canvas');
                frameCanvas.width = this.frameWidth;
                frameCanvas.height = this.frameHeight;
                const frameCtx = frameCanvas.getContext('2d');
                
                // Extract the frame from the main image
                const sourceX = col * this.frameWidth;
                const sourceY = row * this.frameHeight;
                
                frameCtx.drawImage(
                    this.image,
                    sourceX, sourceY,                    // Source position
                    this.frameWidth, this.frameHeight,   // Source size
                    0, 0,                                // Dest position
                    this.frameWidth, this.frameHeight    // Dest size
                );
                
                console.log(`Frame ${frameIndex}: extracted from (${sourceX}, ${sourceY})`);
                return frameCanvas;
            }
            
            showError(message) {
                document.getElementById('loading-status').style.display = 'none';
                document.getElementById('error-display').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            }
            
            // Test with Phaser.js using detected dimensions
            testWithPhaser() {
                console.log('üéÆ Testing sprite with Phaser.js...');
                
                const config = {
                    type: Phaser.AUTO,
                    width: 320,
                    height: 240,
                    parent: 'phaser-canvas-container',
                    backgroundColor: '#2D1B69',
                    scene: {
                        preload: function() {
                            console.log(`Loading sprite with frame size: ${detector.frameWidth}x${detector.frameHeight}`);
                            this.load.spritesheet('puffy_detected', 'assets/puffy_4_by_4.png', {
                                frameWidth: detector.frameWidth,
                                frameHeight: detector.frameHeight
                            });
                        },
                        create: function() {
                            console.log('Creating Phaser sprite...');
                            
                            // Create sprite at center
                            const sprite = this.add.sprite(160, 120, 'puffy_detected', 0);
                            sprite.setScale(3); // Make it bigger to see
                            
                            // Create left-walking animation 
                            this.anims.create({
                                key: 'walk_left',
                                frames: this.anims.generateFrameNumbers('puffy_detected', { 
                                    start: 4, end: 7 
                                }),
                                frameRate: 8,
                                repeat: -1
                            });
                            
                            // Create right-walking animation (flipped left)
                            this.anims.create({
                                key: 'walk_right',
                                frames: this.anims.generateFrameNumbers('puffy_detected', { 
                                    start: 4, end: 7 
                                }),
                                frameRate: 8,
                                repeat: -1
                            });
                            
                            // Demo the left/right flipping
                            sprite.play('walk_left');
                            
                            // Switch between left and right every 2 seconds to show flipping
                            let isRight = false;
                            this.time.addEvent({
                                delay: 2000,
                                callback: () => {
                                    isRight = !isRight;
                                    if (isRight) {
                                        sprite.setFlipX(true);
                                        sprite.play('walk_right');
                                    } else {
                                        sprite.setFlipX(false);
                                        sprite.play('walk_left');
                                    }
                                },
                                loop: true
                            });
                            
                            // Add text
                            this.add.text(160, 200, 'Left/Right flip demo\n(frames 4-7)', {
                                fontSize: '14px',
                                color: '#00ffff',
                                align: 'center'
                            }).setOrigin(0.5);
                            
                            console.log('‚úÖ Phaser test complete!');
                        }
                    }
                };
                
                document.getElementById('phaser-test-result').style.display = 'block';
                new Phaser.Game(config);
            }
        }
        
        // Initialize sprite detector
        let detector;
        
        document.addEventListener('DOMContentLoaded', () => {
            detector = new SpriteDetector();
            
            // Set up button handlers
            document.getElementById('test-phaser').addEventListener('click', () => {
                if (detector.frameWidth > 0) {
                    detector.testWithPhaser();
                } else {
                    alert('Please wait for image analysis to complete first!');
                }
            });
            
            document.getElementById('test-manual-slice').addEventListener('click', () => {
                if (detector.frameWidth > 0) {
                    alert(`Frame size detected: ${detector.frameWidth}x${detector.frameHeight}\nCheck console for extraction details.`);
                } else {
                    alert('Please wait for image analysis to complete first!');
                }
            });
            
            document.getElementById('download-analysis').addEventListener('click', () => {
                const analysis = {
                    imageUrl: 'assets/puffy_4_by_4.png',
                    imageDimensions: detector.image ? `${detector.image.naturalWidth}x${detector.image.naturalHeight}` : 'Unknown',
                    frameSize: `${detector.frameWidth}x${detector.frameHeight}`,
                    totalFrames: 16,
                    gridLayout: '4x4',
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(analysis, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'puffy_sprite_analysis.json';
                a.click();
            });
        });
    </script>
</body>
</html> 